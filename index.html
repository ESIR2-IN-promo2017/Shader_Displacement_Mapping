<!doctype HTML>
<html>
    <head>
        <title>Displacement mapping</title>
        <meta charset="UTF-8"/>

        <!-- common files -->
        <script type="text/javascript" src="gltp1_fichiers/glMatrix-0.js"></script>
        <script type="text/javascript" src="gltp1_fichiers/webgl-utils.js"></script>

        <!-- atomicGL engine -->
        <!-- modules -->
        <script type="text/javascript" src="atomicGLContext.js"></script>
        <script type="text/javascript" src="atomicGLMatrixStack.js"></script>
        <script type="text/javascript" src="atomicGLTexture.js"></script>

        <script type="text/javascript" src="atomicGLClock.js"></script>

        <script type="text/javascript" src="atomicGLShader.js"></script>
        <script type="text/javascript" src="atomicGLDisplacementShader.js"></script>
        <script type="text/javascript" src="atomicGLwaveShader.js"></script>
        <script type="text/javascript" src="atomicGLxzPlane.js"></script>
        <script type="text/javascript" src="atomicGLCube.js"></script>

        <!-- distance map & height map -->
        <script type="text/javascript" src="atomicGLDistanceMap.js"></script>
        <script type="text/javascript" src="heightmap.js"></script>

        <!-- shaders -->
        <script id="bump_vert" type="x-shader/x-vertex">
attribute vec3 aVertexPosition;
attribute vec3 aVertexNormal;
attribute vec3 aVertexColor;
attribute vec2 aVertexTexCoord;

uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
uniform mat3 uNMatrix;

uniform vec3 uAmbientColor;

uniform sampler2D uSampler0;

varying vec2 vTextureCoord;
varying vec3 vcolor;

void main(void)
{
    //TODO
    vec4 mvPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
    gl_Position = uPMatrix * mvPosition;

    vcolor = vec3(0.0, 0.0, 1.0);
    vTextureCoord = aVertexTexCoord;
}
        </script>
        <script id="bump_frag" type="x-shader/x-fragment">
#ifdef GL_ES
    precision highp float;
#endif

uniform sampler2D uSampler0;

varying vec3 vcolor;
varying vec2 vTextureCoord;

void main(void)
{
    gl_FragColor = texture2D(uSampler0, vTextureCoord);//vec4(vcolor, 1.0);
}
        </script>

        <script id="displacement_vert" type="x-shader/x-vertex">
attribute vec3 aVertexPosition;
attribute vec3 aVertexNormal;
attribute vec3 aVertexColor;
attribute vec2 aVertexTexCoord;

uniform mat4 uMVMatrix;
uniform mat4 uPMatrix;
uniform mat3 uNMatrix;

uniform vec3 uAmbientColor;

uniform sampler2D uSampler0;

varying vec2 vTextureCoord;
varying vec3 vcolor;

void main(void)
{
    //TODO
    vec4 mvPosition = uMVMatrix * vec4(aVertexPosition, 1.0);
    gl_Position = uPMatrix * mvPosition;

    vcolor = vec3(0.0, 0.0, 1.0);
    vTextureCoord = aVertexTexCoord;
}
        </script>

        <script id="displacement_frag" type="x-shader/x-fragment">
#ifdef GL_ES
    precision highp float;
#endif

uniform sampler2D uSampler0;

varying vec3 vcolor;
varying vec2 vTextureCoord;

void main(void)
{
    gl_FragColor = texture2D(uSampler0, vTextureCoord);//vec4(vcolor, 1.0);
}
        </script>

        <!-- objects -->
        <script type="text/javascript">
var agl = new atomicGLContext();
var sceneClock = new atomicGLClock();
var ams = new atomicGLMatrixStack();

var progId;

//bump mapping
var bumpProg;
var bumpProgId;

//displacement mapping
var displacementProg;
var displacementProgId;

//var testItem = new atomicGLxzPlane("test_plane",10,10,3,3);
var testItem = new atomicGLCube("test_item", 1, 10, 10, 1, 1);

var angle = 0.0;

function calculateDistanceMap(heightMap, item)
{
}

function webGLStart()
{
    var canvas = document.getElementById("oglcanvas");
    agl.initGL(canvas, [1.0, 1.0, 1.0]);
    agl.pushLight([5.0, 5.0, -10.0], [1.0, 1.0, 1.0]);
    agl.ambientLightColor = [0.01, 0.01, 0.2];

    ams.initMatrix(agl, 45);//FOV

    var colorTexture = new atomicGLTexture("textures/texture_shadow.png", "color", agl);
    var normalMap = new atomicGLTexture("textures/normalmap.png", "color", agl);
    //var distanceMap = new atomicGLDistanceMap(heightMapArray, heightMapHeight, heightMapWidth, agl);

    bumpProg = new atomicGLShader("bump", agl, "bump_frag", "bump_vert", 1, 1);
    bumpProgId = agl.pushProgram(bumpProg);

    displacementProg = new atomicGLShader("displacement", agl, "displacement_frag", "displacement_vert", 1, 1);
    displacementProgId = agl.pushProgram(displacementProg);

    testItem.setFaceColor("All", [0.5, 0.5, 0.5]);
    testItem.pushTexture(colorTexture);
    calculateDistanceMap(heightMapArray, testItem);
    //testItem.pushTexture(distanceMap);
    testItem.initGLBuffers(agl);

    setShader();

    nextFrame();
}

function sceneDraw()
{
    agl.initDraw();

    ams.mvPushMatrix();

        ams.mvTranslate(0, -2, -20);
        ams.mvRotate(20, [1,0,0]);

        ams.mvPushMatrix();

            ams.mvTranslate(0,0,-5);
            ams.mvRotate(angle, [0,1,0]);
            testItem.draw(agl, ams, progId);

        ams.mvPopMatrix();

    ams.mvPopMatrix();
}

function nextFrame()
{
    requestAnimFrame(nextFrame);
    sceneDraw();
    animate();
}

function animate()
{
    sceneClock.tick();
    angle = angle + 0.02*sceneClock.get();
}

function setShader()
{
    if(document.getElementById("chbx").checked)
        progId = displacementProgId;
    else
        progId = bumpProgId;
}
        </script>
    </head>
    <body onLoad="webGLStart();">
        <h1>Displacement mapping</h1>
        <form>
            <input type="checkbox" id="chbx" onClick="setShader();" />
            <label for="chbx"> activer le displacement mapping</label>
        </form>
        <canvas id="oglcanvas" width="600px" height="400px">
        </canvas>
    </body>
</html>
